<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Question Builder — Proctored Test</title>
<style>
  :root { --brand:#4a148c; --brand2:#6a1b9a; --ink:#222; --bg:#F7F4FF; }
  html,body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
  header{position:sticky;top:0;background:#fff;border-bottom:2px solid var(--brand);padding:10px 16px;z-index:10}
  main{max-width:1100px;margin:16px auto;padding:0 16px 80px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input[type="text"],input[type="number"],textarea{padding:10px;border:1px solid #ccc;border-radius:8px;font:inherit}
  input[type="text"]{min-width:220px}
  .btn{background:var(--brand);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.ghost{background:#eee;color:#333;border:1px solid #ddd}
  .btn.warn{background:#d32f2f}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .card{background:#fff;border:1px solid #e7def5;border-radius:12px;margin:14px 0;padding:14px}
  .type{font-size:.8rem;color:#6a1b9a;font-weight:700}
  .qtitle{font-weight:700;margin:6px 0}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .list{display:grid;gap:6px;margin:8px 0}
  .chip{display:flex;gap:6px;align-items:center}
  .chip input{flex:1}
  .muted{color:#666;font-size:.9rem}
  .hr{height:1px;background:#eadfff;margin:14px 0}
</style>
</head>
<body>
<header>
  <div class="row">
    <div><strong style="color:var(--brand)">Question Builder</strong></div>
    <input id="testTitle" type="text" placeholder="Test title" value="Proctored Test"/>
    <label>Duration (min) <input id="duration" type="number" min="1" step="1" value="48" style="width:90px"></label>
    <div class="toolbar">
      <button class="btn" id="addMcq">Add MCQ</button>
      <button class="btn" id="addMatrix">Add Matrix</button>
      <button class="btn" id="addTopic">Add Topic Group</button>
      <button class="btn" id="addShort">Add Short Answer</button>
      <button class="btn" id="addLong">Add Paragraph</button>
    </div>
    <div class="toolbar">
      <button class="btn ghost" id="importJson">Import JSON</button>
      <button class="btn" id="exportJson">Export JSON</button>
      <button class="btn ghost" id="saveDraft">Save Draft</button>
      <button class="btn warn" id="clearAll">Clear All</button>
    </div>
  </div>
</header>

<main>
  <div id="list"></div>
  <p class="muted">Tips: Reorder with ▲/▼. Duplicate to reuse structure. “Topic Group” is a block that contains multiple MCQs under a topic heading.</p>
</main>

<script>
(function(){
  // ---------- Data Model ----------
  let state = {
    schema: "proctored-test@1",
    meta: { title:"Proctored Test", durationMinutes:48 },
    sections: [] // array of question/section objects
  };

  const $ = s => document.querySelector(s);
  const list = $("#list");
  const titleEl = $("#testTitle");
  const durEl = $("#duration");

  titleEl.addEventListener('input', ()=>{ state.meta.title = titleEl.value.trim() || "Untitled Test"; render(); });
  durEl.addEventListener('input', ()=>{ state.meta.durationMinutes = Math.max(1,parseInt(durEl.value||"48",10)); });

  function uid(p){ return p + "_" + Math.random().toString(36).slice(2,8); }

  // ---------- Factory helpers ----------
  function newMcq(){
    return { type:"mcq", id: uid("q"), prompt:"Your MCQ question", required:true, options:["Option A","Option B","Option C","Option D"] };
  }
  function newMatrix(){
    return { type:"matrix", id: uid("m"), prompt:"Rate each item", required:true,
             rows:["Row 1","Row 2","Row 3"], columns:["1","2","3","4","5"] };
  }
  function newTopic(){
    return { type:"topic", id: uid("t"), topic:"Topic title", items:[
      { type:"mcq", id: uid("tq"), prompt:"Topic MCQ #1", required:true, options:["A","B","C","D"] },
      { type:"mcq", id: uid("tq"), prompt:"Topic MCQ #2", required:true, options:["A","B","C","D"] }
    ] };
  }
  function newShort(){ return { type:"short", id: uid("s"), prompt:"Short answer question", required:true }; }
  function newLong(){ return { type:"long", id: uid("l"), prompt:"Paragraph question", required:true }; }

  // ---------- UI Builders ----------
  function button(label, cls, onClick){
    const b = document.createElement('button');
    b.className = "btn" + (cls?(" "+cls):"");
    b.textContent = label;
    b.addEventListener('click', onClick);
    return b;
  }
  function input(val, onInput, placeholder=""){
    const i = document.createElement('input');
    i.type="text"; i.value = val||""; i.placeholder = placeholder;
    i.addEventListener('input', ()=> onInput(i.value));
    return i;
  }
  function textarea(val, onInput, rows=3){
    const t = document.createElement('textarea');
    t.rows = rows; t.value = val||"";
    t.addEventListener('input', ()=> onInput(t.value));
    return t;
  }
  function smallChipList(items, onChange, labelAdd){
    const wrap = document.createElement('div'); wrap.className="list";
    items.forEach((txt, idx)=>{
      const row = document.createElement('div'); row.className="chip";
      const it = input(txt, v=>{ items[idx]=v; onChange(items); });
      const del = button("✕","ghost",()=>{ items.splice(idx,1); onChange(items); render(); });
      row.append(it, del);
      wrap.append(row);
    });
    wrap.append(button("+ "+(labelAdd||"Add"),"ghost",()=>{ items.push(""); onChange(items); render(); }));
    return wrap;
  }

  function sectionHeader(s, titleText){
    const h = document.createElement('div');
    h.className = "row";
    const type = document.createElement('div');
    type.className = "type";
    type.textContent = titleText;
    const controls = document.createElement('div'); controls.className="controls";
    controls.append(
      button("▲","ghost",()=>{ const i = state.sections.indexOf(s); if(i>0){ [state.sections[i-1],state.sections[i]]=[state.sections[i],state.sections[i-1]]; render(); } }),
      button("▼","ghost",()=>{ const i = state.sections.indexOf(s); if(i<state.sections.length-1){ [state.sections[i+1],state.sections[i]]=[state.sections[i],state.sections[i+1]]; render(); } }),
      button("Duplicate","ghost",()=>{ const copy = JSON.parse(JSON.stringify(s)); copy.id = uid(copy.type[0]||"x"); if(copy.items){ copy.items.forEach(it=>it.id=uid("tq")); } state.sections.splice(state.sections.indexOf(s)+1,0,copy); render(); }),
      button("Delete","warn",()=>{ state.sections = state.sections.filter(x=>x!==s); render(); })
    );
    h.append(type, controls);
    return h;
  }

  function renderMcq(s){
    const card = document.createElement('div'); card.className="card";
    card.append(sectionHeader(s,"MCQ"));
    const q = document.createElement('div'); q.className="qtitle"; q.textContent = "Question";
    const prompt = textarea(s.prompt, v=>s.prompt=v, 2);
    const optsLabel = document.createElement('div'); optsLabel.className="qtitle"; optsLabel.textContent="Options";
    const opts = smallChipList(s.options, arr=>s.options=arr, "Add option");
    const req = document.createElement('label');
    const reqCb = document.createElement('input'); reqCb.type="checkbox"; reqCb.checked = !!s.required; reqCb.addEventListener('change',()=>s.required=reqCb.checked);
    req.append(reqCb," Required");
    card.append(q,prompt,optsLabel,opts,req);
    return card;
  }

  function renderMatrix(s){
    const card = document.createElement('div'); card.className="card";
    card.append(sectionHeader(s,"Matrix"));
    card.append(Object.assign(document.createElement('div'),{className:"qtitle",textContent:"Prompt"}));
    card.append(textarea(s.prompt, v=>s.prompt=v, 2));
    card.append(Object.assign(document.createElement('div'),{className:"qtitle",textContent:"Rows"}));
    card.append(smallChipList(s.rows, arr=>s.rows=arr, "Add row"));
    card.append(Object.assign(document.createElement('div'),{className:"qtitle",textContent:"Columns"}));
    card.append(smallChipList(s.columns, arr=>s.columns=arr, "Add column"));
    const req = document.createElement('label');
    const reqCb = document.createElement('input'); reqCb.type="checkbox"; reqCb.checked = !!s.required; reqCb.addEventListener('change',()=>s.required=reqCb.checked);
    req.append(reqCb," Require one choice per row");
    card.append(req);
    return card;
  }

  function renderTopic(s){
    const card = document.createElement('div'); card.className="card";
    card.append(sectionHeader(s,"Topic Group (MCQs)"));
    const lab = Object.assign(document.createElement('div'),{className:"qtitle",textContent:"Topic Title"});
    const topic = input(s.topic, v=>s.topic=v, "Topic");
    card.append(lab,topic, Object.assign(document.createElement('div'),{className:"hr"}));
    s.items.forEach((it, idx)=>{
      const sub = document.createElement('div'); sub.className="card";
      const head = document.createElement('div'); head.className="row";
      head.append(Object.assign(document.createElement('div'),{className:"type",textContent:`Topic MCQ #${idx+1}`}));
      const ctrls = document.createElement('div'); ctrls.className="controls";
      ctrls.append(
        button("▲","ghost",()=>{ if(idx>0){ [s.items[idx-1],s.items[idx]]=[s.items[idx],s.items[idx-1]]; render(); } }),
        button("▼","ghost",()=>{ if(idx<s.items.length-1){ [s.items[idx+1],s.items[idx]]=[s.items[idx],s.items[idx+1]]; render(); } }),
        button("Delete","warn",()=>{ s.items.splice(idx,1); render(); })
      );
      head.append(ctrls);
      sub.append(head);
      sub.append(Object.assign(document.createElement('div'),{className:"qtitle",textContent:"Question"}));
      sub.append(textarea(it.prompt, v=>it.prompt=v, 2));
      sub.append(Object.assign(document.createElement('div'),{className:"qtitle",textContent:"Options"}));
      sub.append(smallChipList(it.options, arr=>it.options=arr, "Add option"));
      const req = document.createElement('label');
      const reqCb = document.createElement('input'); reqCb.type="checkbox"; reqCb.checked = !!it.required; reqCb.addEventListener('change',()=>it.required=reqCb.checked);
      req.append(reqCb," Required");
      sub.append(req);
      card.append(sub);
    });
    card.append(button("+ Add Topic MCQ","ghost",()=>{ s.items.push({type:"mcq", id:uid("tq"), prompt:"New topic MCQ", required:true, options:["A","B","C","D"]}); render(); }));
    return card;
  }

  function renderShort(s){
    const card = document.createElement('div'); card.className="card";
    card.append(sectionHeader(s,"Short Answer"));
    card.append(Object.assign(document.createElement('div'),{className:"qtitle",textContent:"Prompt"}));
    card.append(textarea(s.prompt, v=>s.prompt=v, 2));
    const req = document.createElement('label');
    const reqCb = document.createElement('input'); reqCb.type="checkbox"; reqCb.checked = !!s.required; reqCb.addEventListener('change',()=>s.required=reqCb.checked);
    req.append(reqCb," Required");
    card.append(req);
    return card;
  }

  function renderLong(s){
    const card = document.createElement('div'); card.className="card";
    card.append(sectionHeader(s,"Paragraph"));
    card.append(Object.assign(document.createElement('div'),{className:"qtitle",textContent:"Prompt"}));
    card.append(textarea(s.prompt, v=>s.prompt=v, 4));
    const req = document.createElement('label');
    const reqCb = document.createElement('input'); reqCb.type="checkbox"; reqCb.checked = !!s.required; reqCb.addEventListener('change',()=>s.required=reqCb.checked);
    req.append(reqCb," Required");
    card.append(req);
    return card;
  }

  function render(){
    titleEl.value = state.meta.title;
    durEl.value = state.meta.durationMinutes;
    list.innerHTML = "";
    state.sections.forEach(s=>{
      let el;
      if(s.type==="mcq") el = renderMcq(s);
      else if(s.type==="matrix") el = renderMatrix(s);
      else if(s.type==="topic") el = renderTopic(s);
      else if(s.type==="short") el = renderShort(s);
      else if(s.type==="long") el = renderLong(s);
      if(el) list.append(el);
    });
  }

  // ---------- Toolbar actions ----------
  $("#addMcq").addEventListener('click',()=>{ state.sections.push(newMcq()); render(); });
  $("#addMatrix").addEventListener('click',()=>{ state.sections.push(newMatrix()); render(); });
  $("#addTopic").addEventListener('click',()=>{ state.sections.push(newTopic()); render(); });
  $("#addShort").addEventListener('click',()=>{ state.sections.push(newShort()); render(); });
  $("#addLong").addEventListener('click',()=>{ state.sections.push(newLong()); render(); });

  $("#exportJson").addEventListener('click',()=>{
    const json = JSON.stringify(state, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'questions.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("#importJson").addEventListener('click',()=>{
    const inp = document.createElement('input');
    inp.type='file'; inp.accept='.json,application/json';
    inp.onchange = () => {
      const f = inp.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=> {
        try{
          const data = JSON.parse(r.result);
          if(!data || !data.schema || !data.sections){ alert("Invalid JSON"); return; }
          state = data; render();
        }catch(e){ alert("Could not parse JSON"); }
      };
      r.readAsText(f);
    };
    inp.click();
  });

  $("#saveDraft").addEventListener('click',()=>{ localStorage.setItem("qb_draft", JSON.stringify(state)); alert("Draft saved locally."); });
  $("#clearAll").addEventListener('click',()=>{ if(confirm("Clear all questions?")){ state.sections=[]; render(); } });

  // ---------- Init ----------
  const saved = localStorage.getItem("qb_draft");
  if(saved){ try{ state = JSON.parse(saved); }catch{} }
  render();
})();
</script>
</body>
</html>
